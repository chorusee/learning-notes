## MySQL事务

### 事务是什么？

事务可以用来维护数据库的完整性，它保证成批的MySQL操作要么完全执行，要么完全不执行。

下面是事务的几个术语：

+ 事务（transaction）指一组SQL语句；
+ 回退（rollback）指撤销指定SQL语句的过程；
+ 提交（commit）指将未存储的SQL语句结果写入数据库表；
+ 保留点（savepoint）指事务处理中设置的临时占位符，可以堆它发布回退。

开始事务：

```sql
start transaction;
```

回退：

```sql
rollback;
```

可以回退insert、update、和delete语句。不能回退select语句（这样做也没什么意义）。不能回退create或drop操作，在事务处理块中可以使用这两条语句，但如果执行回退，不会撤销。

提交：

```sql
commit;
```

保留点：

```sql
savepoint delete1;   # 后接保留点名
```

更改默认提交行为：

```sql
set autocommit=0;    # 针对每个连接而不是服务器
```

### 事务的ACID特性

+ 原子性（atomicity）：一个事务必须被视为不可分割的最小工作单元，整个事务中的操作要么全部执行成功，要么全部失败回滚。
+ 一致性（consistency）：数据库总是从一个一致状态转换到另一个一致的状态。
+ 隔离性（isolation）：通常来说，一个事务所做的任何修改在最终提交前，对其他事务是不可见的。
+ 持久性（durability）：一旦事务提交，则其所做的修改就会永久保存到数据库中。即使系统崩溃，数据也不会丢失。

### 隔离级别

SQL标准中定义了四种隔离级。

+ READ UNCOMMITTED（读未提交）

  在这个级别中，事务中的修改即使没有提交，对其他事务也是可见的。事务可以读取未提交的数据，这称为脏读。

+ READ COMMITTED（读提交）

  大多数数据库系统的默认隔离级别（但MySQL不是）。一个事务从开始到提交之前，所做的任何修改对其他事务都是不可见的。

  这个级别有时候也称不可重复读，因为在同一事务中执行两次同样的查询，可能会得到不同的结果。

+ REPEATABLE READ（可重复读）

  MySQL默认隔离级别。可重复读解决了脏读问题。该级别保证了在同一个事务中多次读取同样记录的结果是一致的。该隔离级别还是无法解决幻读问题。

  所谓幻读，指的是当某个事务在读取某个范围内的记录时，另一个事务又在该范围内插入了新的记录，当之前的事务再读取该范围的记录时，会产生幻行。

  InnoDB通过多版本并发控制（MVCC，Multiversion Concurrency Control）解决了幻读问题。

+ SERIALIZABLE（可串行化）‘

  SERIALIZABLE是最高的隔离级别。它通过强制事务串行执行，避免了前面说的幻读问题。

![image-20210521002314030](C:\Users\yxlself\AppData\Roaming\Typora\typora-user-images\image-20210521002314030.png)

### MySQL中的事务

MySQL默认从采用自动提交模式。

可通过`SET TRANSACTION ISOLATION LEVEL`来设置隔离级别。

### 多版本并发控制（MVCC）

MySQL的大多数事务型存储引擎实现的都不是简单的行级锁。基于提升并发性能的考虑，他们一般实现了多版本并发控制。

可以认为MVCC是行级锁的一个变种，但是它在很多情况下避免了加锁操作，因此开销更低。实现了非阻塞的读操作，写操作也只锁定必要的行。

MVCC的实现，是通过保存数据在某个时间点的快照来实现的。

不同的存储引擎的MVCC实现是不同的，典型的有乐观并发控制和悲观并发控制。

InnoDB的MVCC，是通过在每行记录后面保存两个隐藏的列来实现的。这两个列，一个保存了行的创建时间，一个保存行的过期时间（或删除时间）。当然存储的不是实际的时间值，而是系统版本号。每开始一个新事物，系统版本号会自动递增。事务开始时刻的系统版本号作为事务的版本号，用来和查询到的每行记录的版本号进行比较。

在REPEATABLE READ隔离级别下，InnoDB根据以下两个条件检查每行记录：

1. 只查找版本早于当前事务版本的数据行（行的系统版本号小于或等于事务的系统版本号），这样可以确保事务读取的行，要么是在事务开始前就已经存在，要么是事务自身插入或者修改过的。
2. 查找的行的删除版本要么未定义，要么大于当前事务版本号，这可以确保事务读取到的行，在事务开始前未被删除。
3. InnoDB为新插入的每一行记录保存当前系统版本号作为行版本号。
4. InnoDB为删除的每一行保存当前系统版本号作为行删除标识。
5. 更新时InnoDB插入一行新纪录，保存当前版本号作为行版本号，同时保存当前系统版本号到原来的行作为删除标识。

保存这两个额外的系统版本号，使大多数读操作都可以不用换加锁。这样实际读数据操作很简单，性能很好，并且也能保证只会读取符合标准的行，不足之处是每行记录都需要额外的存储空间，需要做更多的行检查工作，以及一些额外的维护工作。

MVCC只在REPEATABLE READ和READ COMMITTED两个级别下工作。READ UNCOMMITTED总会读取最新的数据行，而不是符合当前事务版本的数据，而SERIALIZABLE则会对所有读取的行加锁。

### 间隙锁

间隙锁是InnoDB为解决可重复读隔离级别下幻读问题引入的锁机制。