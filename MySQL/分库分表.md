### 分库分表

分库分表就是为了解决由于数据量过大而导致的数据库性能下降的问题，将原来独立的数据库拆分为若干数据库组成，将数据大表拆分为若干数据表组成，使得单一数据库、单一数据表的数据量变小，从而达到提升数据库性能的目的。

#### 垂直分表

> 将一张表按照字段分为多表，每张表存储其中一部分信息。

以商品列表为例，用户在浏览商品列表时，只有对某商品感兴趣才会查看该商品的详细信息。商品信息中商品描述字段访问频次较低，且该字段占用存储空间大，访问单个数据IO时间长；商品名称、商品图片、商品价格等字段访问频次较高。

因此考虑将访问频次低的信息存放在一张单独的表中，访问频次高的信息存放在另一张表中。

分表原则：

1. 把不常用的字段单独放在一张表中；
2. 把text， blob等大字段拆分出来放在附表中；
3. 经常组合查询的列放在一张表中。

#### 垂直分库

> 垂直分库是按照业务将表进行分类，分不到不同的数据库上面，每个库可以放在不同的服务器上，它的核心理念是专库专用。

通过垂直分表性能得到了一定的提升，但是还没有达到要求，并且磁盘空间也快不够了。因为数据还是限制在一台服务器上，库内垂直分表只解决了单一表数据量过大的问题，但没有将表分布到不同的服务器上，所有的表还是竞争同一个物理机的CPU、内存、网络IO、磁盘等。

还是以电商为例，原来有有一个卖家库，现在将其拆分为商品库和店铺库。商品信息和商品描述存放在商品库上，店铺信息存放在店铺库。

带来的提升是：

+ 解耦，业务清晰
+ 能对不同业务的数据进行分级管理、维护、监控、扩展等
+ 高并发场景下，垂直分库一定程度提高了性能，降低单机硬件资源瓶颈

#### 水平分库

> 水平分库是把同一张表的数据行按照一定的规则拆分到不同的数据库中，每个库可以放在不同的服务器上。水品分库是对行的拆分，不影响表结构。

若一张商品表有几千万行数据，且商品表属于访问非常频繁的资源，单台服务器无法支撑，如何优化？

尝试水平分库，将店铺ID为单数的和店铺ID为双数的商品信息分在两个库中。

带来的提升是：

+ 解决了单库大数据，高并发的性能瓶颈
+ 提高了系统的稳定性以及可用性

水平分库的扩展问题：

+ 停服迁移：增加新库，修改路由规则，然后停服进行数据迁移。
+ 升级从库：为每台主库配一台从库，当需要扩容的时候，把从库升级为新的主库，同时在上层做好分片配置，再对冗余数据进行一次清理。处理完之后，为保证高可用以及下一步扩容，为现有主库分配一个从库。
+ 双写迁移：原理与上述相同，做分裂扩容，只是数据同步方式不同。上层同时写两份数据，旧库跟新库，并将老库的数据迁移到新库。然后做好上层分片配置，清除冗余数据。

#### 水平分表

> 水平分表是在同一个数据库内，把同一张表的数据行按照一定规则拆分到多个表中。

带来的提升是：

+ 优化单一表数据量过大而产生的性能问题，提高检索性能
+ 避免IO争抢并减少了锁表的几率

#### 数据库查询优化

建立索引 -> 缓存 -> 读写分离 -> 分库分表