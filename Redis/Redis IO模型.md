## Redis IO模型

Redis服务器是一个事件驱动程序，服务器需要处理一下两类事件：

+ 文件事件：Redis服务器通过套接字与客户端进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作。
+ 时间事件：Redis服务器的一些操作需要在给定的时间点执行，而时间事件就是服务器对这类事件的抽象。

Redis开发了自己的网络事件处理器，称为文件事件处理器。

文件事件处理器使用IO多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器。

![image-20210531000627972](C:\Users\yxlself\AppData\Roaming\Typora\typora-user-images\image-20210531000627972.png)

文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答、写入、读取、关闭操作时，就会产生一个文件事件。

IO多路复用程序负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字。

IO多路复用程序会将所有产生事件的套接字都放到一个队列里面，然后通过这个队列，以有序、同步、每次一个套接字的方式向文件事件分派器传送套接字。

文件事件分派器接收IO多路复用程序传送来的套接字，并根据套接字产生的事件类型，调用相应的事件处理器。

服务器会为执行不同任务的套接字关联不同的事件处理器，这些处理器是一个个函数，他们定义了某个事件发生时，服务器应该执行的动作。

### IO模型

同步和异步的概念描述的是用户线程与内核的交互方式：同步是指用户线程发起IO请求后需要等待或轮询内核IO操作完成后才能继续执行；而异步是指用户线程发起IO请求后任然继续执行其他任务，当内核IO操作完成后会通知用户线程，或者调用用户线程注册的回调函数。

阻塞和非阻塞的概念描述的是用户线程调用内核IO操作的方式，阻塞是指IO操作需要彻底完成之后才返回用户空间，而非阻塞是指IO操作被调用后立即返回给用户一个状态值，无需等到IO彻底完成。

### 同步阻塞IO

![img](https://images0.cnblogs.com/blog/405877/201411/142330286789443.png)

### 同步非阻塞IO

![img](https://images0.cnblogs.com/blog/405877/201411/142332004602984.png)

整个IO请求过程中，虽然用户每次发起IO请求后可以立即返回，但是为了等到数据，任需要不停地轮询、重复请求，消耗了大量的CPU资源。

### IO多路复用

![img](https://images0.cnblogs.com/blog/405877/201411/142332187256396.png)

用户首先将需要进行IO操作的socket添加到select中，然后阻塞等待select系统调用返回。当数据到达时，socket被激活，select函数返回。用户线程正式发起read请求，读取数据并继续执行。

从流程上来看，使用select函数进行IO请求和同步阻塞模型没有太大的区别，甚至还多了添加监视socket，以及调用select函数的额外操作，效率更差。但是，使用select以后最大的优势是用户可以在一个线程内同时处理多个socket的IO请求。用户可以注册多个socket，然后不断地调用select读取被激活的socket，即可达到在**同一个线程内同时处理多个IO请求的目的**。而在同步阻塞模型中，必须通过多线程的方式才能达到这个目的。

![img](https://images0.cnblogs.com/blog/405877/201411/142333254136604.png)

通过Reactor的方式，可以将用户线程轮询IO操作状态的工作统一交给handle_events事件循环进行处理。用户线程注册事件处理器之后可以继续执行做其他的工作（异步），而Reactor线程负责调用内核的select函数检查socket状态。当有socket被激活时，则通知相应的用户线程（或执行用户线程的回调函数），执行handle_event进行数据读取、处理的工作。由于select函数是阻塞的，因此多路IO复用模型也被称为异步阻塞IO模型。注意，这里的所说的阻塞是指select函数执行时线程被阻塞，而不是指socket。一般在使用IO多路复用模型时，socket都是设置为NONBLOCK的，不过这并不会产生影响，因为用户发起IO请求时，数据已经到达了，用户线程一定不会被阻塞。

### 异步IO

![img](https://images0.cnblogs.com/blog/405877/201411/142333511475767.png)